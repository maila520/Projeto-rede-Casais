<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encontro de Casais üíû - Vota√ß√£o</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

  body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(to bottom right, #4a0e23, #7b1e3a);
    color: #fff;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  h1 {
    color: #ffd6e0;
    font-size: 3em;
    margin-top: 30px;
    font-weight: 700;
    text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.4);
  }

  form {
    background: #fff;
    margin: 40px auto;
    padding: 45px 40px;
    border-radius: 25px;
    max-width: 700px;
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    border: 3px solid #7b1e3a;
    color: #4a0e23;
    font-size: 1.4em;
  }

  select,
  button {
    width: 90%;
    margin: 14px 0;
    padding: 18px;
    border: 2px solid #7b1e3a;
    border-radius: 12px;
    font-size: 1.3em;
    background: #fff;
    color: #4a0e23;
    transition: all 0.3s ease;
  }

  select:focus {
    outline: none;
    border-color: #a83256;
    box-shadow: 0 0 10px rgba(168, 50, 86, 0.5);
  }

  button {
    background-color: #7b1e3a;
    color: white;
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 1.4em;
    transition: all 0.3s ease;
    border: none;
  }

  button:hover {
    background-color: #a83256;
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(168, 50, 86, 0.4);
  }

  .resultados {
    background: #fff;
    margin: 40px auto;
    padding: 40px;
    border-radius: 25px;
    max-width: 700px;
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    border: 3px solid #7b1e3a;
    color: #4a0e23;
    font-size: 1.4em;
  }

  h2 {
    color: #7b1e3a;
    font-size: 2.2em;
    margin-bottom: 15px;
    font-weight: 700;
  }

  ul {
    list-style: none;
    padding: 0;
    font-size: 1.3em;
  }

  li {
    padding: 12px;
    border-bottom: 1px solid #f3ccd2;
  }

  footer {
    margin-top: 40px;
    padding: 20px;
    background-color: #3a0d1f;
    color: #ffd6e0;
    font-size: 1.3em;
    letter-spacing: 0.5px;
  }

  /* === Modal === */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal {
    background: #7b1e3a;
    padding: 60px 55px;
    border-radius: 25px;
    width: 95%;
    max-width: 850px; /* ficou bem mais largo */
    box-shadow: 0 12px 50px rgba(0, 0, 0, 0.6);
    text-align: center;
    border: 4px solid #fff;
    color: #fff;
  }

  .modal h3 {
    margin-top: 0;
    color: #fff;
    font-size: 2.6em;
    font-weight: 700;
  }

  .modal p {
    color: #ffe5ec;
    font-size: 1.6em;
    margin-top: 12px;
    font-weight: 500;
  }

  .modal input {
    width: 100%;
    padding: 20px;
    margin-top: 20px;
    border-radius: 12px;
    border: 3px solid #fff;
    background: #fff;
    font-size: 1.5em;
    color: #4a0e23;
    transition: 0.3s;
    font-family: 'Montserrat', sans-serif;
  }

  .modal input:focus {
    outline: none;
    border-color: #ffd6e0;
    box-shadow: 0 0 10px rgba(255, 214, 224, 0.5);
  }

  .modal .actions {
    margin-top: 35px;
    text-align: right;
  }

  .modal .actions button {
    background-color: #fff;
    color: #7b1e3a;
    border: none;
    padding: 16px 35px;
    border-radius: 10px;
    font-size: 1.4em;
    cursor: pointer;
    transition: 0.3s;
    font-weight: 700;
  }

  .modal .actions button:hover {
    background-color: #ffd6e0;
    color: #4a0e23;
    transform: scale(1.05);
  }

  /* üíñ Toque rom√¢ntico e acolhedor */
  form,
  .resultados,
  .modal {
    position: relative;
  }

  form::before,
  .resultados::before {
    content: "üíñ";
    position: absolute;
    font-size: 1.8em;
    top: 12px;
    right: 18px;
    opacity: 0.3;
  }

  .modal::before {
    content: "‚ù§Ô∏è";
    position: absolute;
    font-size: 3.5em;
    top: 15px;
    left: 20px;
    opacity: 0.15;
  }
</style>

</head>

<body>
  <h1>üíñ Vota√ß√£o - Encontro de Casais üíñ</h1>
  <form id="formVotacao">
    <label>Selecione seu casal üíë</label>
    <select id="nomeVotante" required>
      <option value="">-- Selecione seu casal --</option>
    </select>

    <label>Casal mais animado üòÇ</label>
    <select id="animado"></select>
    <label>Casal mais unido em tudo ü§ù</label>
    <select id="unido"></select>
    <label>Casal mais tranquilo e sereno üòå</label>
    <select id="tranquilo"></select>
    <label>Casal mais sorridente üòÑ</label>
    <select id="sorridente"></select>
    <label>Casal mais carinhoso üíû</label>
    <select id="carinhoso"></select>
    <label>Casal mais inspirador üåü</label>
    <select id="inspiracao"></select>
    <label>Casal mais apaixonado üíû</label>
    <select id="apaixonado"></select>
    <label>Casal que mais demonstra f√© üôè</label>
    <select id="fe"></select>
    <label>Casal que mais se completa ‚ù§Ô∏è</label>
    <select id="completa"></select>
    <label>Casal mais comunicativo üó£Ô∏è</label>
    <select id="comunicativo"></select>
    <label>Casal supera√ß√£o(venceu desafios juntos) üí™</label>
    <select id="superacao"></select>
    <label>Casal mais elegante üíÉüï∫</label>
    <select id="elegante"></select>
    <label>Casal mais romantico üíû</label>
    <select id="romantico"></select>
    <label>Casal mais acolhedor ü§ó</label>
    <select id="acolhedor"></select>
    <label>Casal mais harmonia com todos ü§ù</label>
    <select id="harmonia"></select>
    <label>Casal mais engra√ßado üòÇ</label>
    <select id="engra√ßado"></select>

    <button type="submit">Enviar Voto üíå</button>
  </form>

  <div class="resultados" id="divRanking">
    <h2>üèÜ Ranking dos Casais Mais Votados</h2>
    <ul id="ranking"></ul>
  </div>

  <div class="resultados" id="divVotantes">
    <h2>üìù Quem J√° Votou</h2>
    <ul id="votantes"></ul>
  </div>

  <footer>Feito com üíï para o Encontro de Casais da Igreja IBVA</footer>

  <!-- Modal de senha -->
  <div class="modal-backdrop" id="pwModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h3 id="pwTitle">Acesso restrito</h3>
      <p>Digite a senha para visualizar o ranking e a lista de votantes.</p>
      <input id="pwInput" type="password" placeholder="Senha" />
      <div class="actions">
        <button id="pwCancel" type="button">Cancelar</button>
        <button id="pwSubmit" type="button">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    /* === Dados e configura√ß√£o === */
    const casais = [
      "Elmano e Ana", "Joabe e Gleide", "Salom√£o e Nildete", "Bonfim e Celma",
      "Marcio e Eliene", "Eric e Andreara", "Luciano e Evelin", "Leonardo e Adriana",
      "Lindomar e Paula", "Marc√£o e Viviane", "Frances e Silvana", "Jaciano e Patricia",
      "Nailton e Jacira", "F√°bio e Marlene", "Elisangela e Claudio", "Nat√£ e Maila",
      "Deri e Naiana", "Paulo e Giselia", "Tony e Adriana", "Mateus e Barbara",
      "Silvio e Jeane", "Elmo e Talita", "Moises e Joice", "Uelington e Lve",
      "Beto e Lais", "Adilma e Andr√©", "Giliane e Roberto", "Sheila e Esposo",
      "Gomes e Gra√ßa", "Ant√¥nio e Jucineide", "Alex e L√∫cia"
    ];

    // IDs dos selects (devem estar iguais ao HTML)
    const categorias = ["animado","unido","tranquilo","sorridente","carinhoso","inspiracao","apaixonado","fe","completa","comunicativo","superacao","elegante","romantico","acolhedor","harmonia","engra√ßado"];

    // agora apenas estes dois casais t√™m permiss√£o, mas exigir√£o senha:
    const casaisAutorizados = ["Nat√£ e Maila", "Joabe e Gleide"];

    // senha exigida (exata)
    const SENHA = "cafeteira";

    // JSONBin config (mantenha suas credenciais)
    const API_KEY = "$2a$10$5MkP8u/0Aw44UKNpoB8BUOkAkRPRGOtsLwnCui5hJnuWP8ZeIbv9.";
    const BIN_ID  = "690cec3bd0ea881f40d8478b";

    /* === Fun√ß√µes JSONBin (como antes) === */
    async function carregarVotos() {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: { "X-Master-Key": API_KEY }
        });
        const data = await res.json();
        return data.record || { votos: [], votantes: [] };
      } catch (err) {
        console.error("Erro carregarVotos:", err);
        return { votos: [], votantes: [] };
      }
    }

    async function salvarVotos(votos, votantes) {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": API_KEY
          },
          body: JSON.stringify({ votos, votantes })
        });
        return res.ok;
      } catch (err) {
        console.error("Erro salvarVotos:", err);
        return false;
      }
    }

    /* === Preenche selects === */
    function preencherSelects() {
      const selectVotante = document.getElementById("nomeVotante");
      casais.forEach(casal => {
        const op = document.createElement("option");
        op.value = casal; op.textContent = casal;
        selectVotante.appendChild(op);
      });

      categorias.forEach(cat => {
        const select = document.getElementById(cat);
        const placeholder = document.createElement("option");
        placeholder.value = ""; placeholder.textContent = "-- Escolha um casal --";
        placeholder.disabled = true; placeholder.selected = true;
        select.appendChild(placeholder);

        casais.forEach(casal => {
          const op = document.createElement("option");
          op.value = casal; op.textContent = casal;
          select.appendChild(op);
        });
      });
    }

    /* === Atualiza ranking e votantes na tela === */
    function atualizarListas(votos, votantes) {
      const rankingEl = document.getElementById("ranking");
      const votantesEl = document.getElementById("votantes");
      const contagem = {};
      votos.forEach(v => {
        Object.values(v).forEach(nome => {
          if (!nome) return;
          contagem[nome] = (contagem[nome] || 0) + 1;
        });
      });
      const rankingHtml = Object.entries(contagem)
        .sort((a,b)=>b[1]-a[1])
        .map(([n,q])=>`<li><b>${n}</b> - ${q} votos</li>`).join("");
      rankingEl.innerHTML = rankingHtml || "<li>Nenhum voto ainda üí≠</li>";
      votantesEl.innerHTML = votantes.length ? votantes.map(v => `<li>${v}</li>`).join("") : "<li>Ningu√©m votou ainda üíå</li>";
    }

    /* === Controle de visibilidade dos blocos de resultados === */
    function podeVerResultados(nomeVotante) {
      if (!nomeVotante) return false;
      if (!casaisAutorizados.includes(nomeVotante)) return false;
      // verificar se j√° autenticou nesta sess√£o
      return sessionStorage.getItem("auth_" + nomeVotante) === "1";
    }

    function atualizarVisibilidadeResultados(nomeVotante) {
      const divRanking = document.getElementById("divRanking");
      const divVotantes = document.getElementById("divVotantes");
      const mostra = podeVerResultados(nomeVotante);
      divRanking.style.display = mostra ? "block" : "none";
      divVotantes.style.display = mostra ? "block" : "none";
    }

    /* === Impedir que o casal vote em si mesmo (desabilitar op√ß√µes) === */
    function atualizarOpcoesParaVotante(votanteSelecionado) {
      categorias.forEach(catId => {
        const select = document.getElementById(catId);
        if (!select) return;
        for (let i = 0; i < select.options.length; i++) {
          const opt = select.options[i];
          if (opt.value === "") continue;
          if (votanteSelecionado && opt.value === votanteSelecionado) {
            opt.disabled = true;
            if (select.value === opt.value) select.value = "";
          } else {
            opt.disabled = false;
          }
        }
      });
    }

    /* === Modal senha === */
    const pwModal = document.getElementById("pwModal");
    const pwInput = document.getElementById("pwInput");
    const pwSubmit = document.getElementById("pwSubmit");
    const pwCancel = document.getElementById("pwCancel");

    function showPasswordModal() {
      pwInput.value = "";
      pwModal.style.display = "flex";
      pwInput.focus();
    }
    function hidePasswordModal() {
      pwModal.style.display = "none";
    }

    pwCancel.addEventListener("click", () => {
      hidePasswordModal();
      // opcional: limpa sele√ß√£o para evitar confus√£o
      document.getElementById("nomeVotante").value = "";
      atualizarOpcoesParaVotante(null);
      atualizarVisibilidadeResultados(null);
    });

    pwSubmit.addEventListener("click", () => {
      const nomeSelecionado = document.getElementById("nomeVotante").value;
      const senha = pwInput.value;
      if (senha === SENHA && casaisAutorizados.includes(nomeSelecionado)) {
        // marca como autenticado nesta sess√£o
        sessionStorage.setItem("auth_" + nomeSelecionado, "1");
        hidePasswordModal();
        atualizarVisibilidadeResultados(nomeSelecionado);
        // buscar dados e atualizar tela
        (async () => {
          const { votos, votantes } = await carregarVotos();
          atualizarListas(votos, votantes);
        })();
      } else {
        alert("Senha incorreta.");
      }
    });

    /* Quando muda o votante selecionado */
    document.getElementById("nomeVotante").addEventListener("change", async function() {
      const votante = this.value || null;
      atualizarOpcoesParaVotante(votante);

      // Se o votante √© um dos autorizados e ainda n√£o autenticado -> pedir senha
      if (casaisAutorizados.includes(votante) && sessionStorage.getItem("auth_" + votante) !== "1") {
        // mostrar modal pedindo senha
        showPasswordModal();
        // garantir resultados ocultos at√© autentica√ß√£o
        atualizarVisibilidadeResultados(null);
      } else {
        // atualizar visibilidade conforme sess√£o
        atualizarVisibilidadeResultados(votante);
        // se j√° pode ver, atualizar listas com dados do servidor
        if (podeVerResultados(votante)) {
          const { votos, votantes } = await carregarVotos();
          atualizarListas(votos, votantes);
        }
      }
    });

    /* === Envio do formul√°rio === */
    document.getElementById("formVotacao").addEventListener("submit", async function(e) {
      e.preventDefault();
      const nome = document.getElementById("nomeVotante").value;
      if (!nome) return alert("Selecione seu casal antes de votar! üíë");

      // carregar dados atuais
      const data = await carregarVotos();
      const votos = Array.isArray(data.votos) ? data.votos : [];
      const votantes = Array.isArray(data.votantes) ? data.votantes : [];

      if (votantes.includes(nome)) return alert("Esse casal j√° votou hoje! üíû");

      const voto = {
        engra√ßado: document.getElementById("engra√ßado").value || null,
        comunicativo: document.getElementById("comunicativo").value || null,
        romantico: document.getElementById("romantico").value || null,
        harmonia: document.getElementById("harmonia").value || null,
        animado: document.getElementById("animado").value || null,
        unido: document.getElementById("unido").value || null,
        tranquilo: document.getElementById("tranquilo").value || null,
        sorridente: document.getElementById("sorridente").value || null,
        carinhoso: document.getElementById("carinhoso").value || null,
        inspiracao: document.getElementById("inspira√ß√£o").value || null,
        apaixonado: document.getElementById("apaixonado").value || null,
        fe: document.getElementById("f√©").value || null,
        completa: document.getElementById("completa").value || null,
        superacao: document.getElementById("supera√ß√£o").value || null,
        elegante: document.getElementById("elegante").value || null,
        acolhedor: document.getElementById("acolhedor").value || null,
        ts: new Date().toISOString()
      };

      // valida√ß√£o: n√£o pode votar em si mesmo
      if (Object.values(voto).includes(nome)) {
        return alert("Voc√™ n√£o pode votar no pr√≥prio casal! üíî Escolha outros casais.");
      }

      votos.push(voto);
      votantes.push(nome);

      const ok = await salvarVotos(votos, votantes);
      if (!ok) {
        return alert("Erro ao salvar o voto. Tente novamente mais tarde.");
      }

      alert("Voto registrado com sucesso! üíñ");
      this.reset();
      atualizarOpcoesParaVotante(null);

      // atualizar listas ‚Äî caso o atual selecionado possa ver (j√° autenticado), atualizar
      const current = document.getElementById("nomeVotante").value;
      if (podeVerResultados(current)) {
        const fresh = await carregarVotos();
        atualizarListas(fresh.votos, fresh.votantes);
      } else {
        // se n√£o pode ver, garantir resultados ocultos
        atualizarVisibilidadeResultados(null);
      }
    });

    /* === Inicializa√ß√£o: preencher selects e carregar dados iniciais (sem mostrar) === */
    (async function init() {
      preencherSelects();
      atualizarOpcoesParaVotante(null);
      atualizarVisibilidadeResultados(null);
      // carregar e preparar listas (dados iniciais) ‚Äî n√£o mostrados at√© autentica√ß√£o
      const { votos, votantes } = await carregarVotos();
      // atualiza listas internas (√∫til quando autenticarem)
      // n√£o exibimos ainda; quando autenticado, carregamos de novo
      // mas vamos atualizar a UI caso alguem j√° esteja autenticado em sess√£o:
      const nomeAtivo = document.getElementById("nomeVotante").value || null;
      if (podeVerResultados(nomeAtivo)) {
        atualizarListas(votos, votantes);
        atualizarVisibilidadeResultados(nomeAtivo);
      }
    })();
  </script>
</body>
</html>
